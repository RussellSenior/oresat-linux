AM335x
======
Some of our systems need more computing power, so theyâ€™re given a 
`AM335x <https://octavosystems.com/octavo_products/osd335x-sm/>`_ that can run Linux.
It is commonly found in Beagleboard's `PocketBeagle <https://beagleboard.org/pocket>`_

Key features of the AM335X:
    - A single core 1GHz ARM Cortex A8 processor
    - 2 PRU (Programable Realtime Processors)
    - 2 CAN processors
    - Version with 1GB of RAM

Programmable Real-time Unit (PRU)
---------------------------------
The AM335x has two PRU. For oresat an idea is use them to get images from
camera sensor.

Good guides can be found at:
    - `PRU-ICSS <https://processors.wiki.ti.com/index.php/PRU-ICSS>`_
    - `TI PRU-ICSS / PRU_ICSSG <http://software-dl.ti.com/processor-sdk-linux/esd/docs/latest/linux/Foundational_Components_PRU-ICSS_PRU_ICSSG.html>`_
    - `TI PRU Training <https://processors.wiki.ti.com/index.php/PRU_Training:_Hands-on_Labs>`_

OreSat projects using PRUs
 - `oresat-star-tracker-software <https://github.com/oresat/oresat-star-tracker-software>`_
 - `oresat-gps-software <https://github.com/oresat/oresat-gps-software>`_

TI PRU Code Generation Tools

- On Debian, apt can be used to get it 
    .. code-block:: bash

     apt install ti-pru-cgt-installer

- Or get it directy from TI at `<https://www.ti.com/tool/download/PRU-CGT-2-1>`_. The ARM-A8 Installer for PRU CGT one.

CAN on AM335x
-------------

Enabling CAN1 on the BeagleBone Black (pins P9_19 P9_20)

- Edit /boot/uEnt.txt
    - add line `dtb-overlay=/lib/firmware/BB-CAN1-00A0.dtbo` under Custom Cape
    - comment out `enable_uboot_cape_universal=1`
    - reboot BeagleBone
- Turn on CAN0
    .. code-block:: bash
        
        $ sudo ip link set can0 up type can bitrate 1000000


Enabling CAN1 on the pocketbeagle (pins P2_09 P2_11)

- Edit /boot/uEnt.txt
    - add line `dtb-overlay=/lib/firmware/PB-CAN1-00A0.dtbo` under Custom Cape
    - comment out `enable_uboot_cape_universal=1`
    - reboot PocktetBeagle
- Turn on CAN1
    .. code-block:: bash

        $ sudo ip link set can1 up type can bitrate 1000000

Device Tree
-----------
ARM uses a device tree to set hardware descriptions like memory sizing, pin
muxing, interupts configurations, and more. It is recommend to let the boot
loader handle loading the device tree. 

**BeagleBoards and capemgr**

BeagleBoard Linux images have capemgr. Capemgr allows for dynamic device tree,
but it limited to kernel they modified to support it. It is done by device tree
overlays. As the name implies, these are device tree binary overlay are just
applied ontop of the actual device tree.

**How to make dtbo files**

Device tree on mainline Linux are not dynamic, meaning it's not able to change
or be patched on runtime or by userspace, but it can be recompiled as needed.

- Install device tree compiler

.. code-block:: bash

    sudo apt install device-tree-compiler

- Compile dts into dtb

.. code-block:: bash

    dtc -I dts -O dtb -f devicetree_file_name.dts -o devicetree_file_name.dtb

- Disassemble dtb into dts

.. code-block:: bash

    dtc -I dtb -O dts -f devicetree_file_name.dtb -o devicetree_file_name.dts

Useful Links

- `Device-Tree-Specs <https://www.devicetree.org/specifications/>`_
- `Device-Tree-Reference <https://elinux.org/Device_Tree_Reference>`_
- `TI-pin-mux-tool <http://www.ti.com/tool/PINMUXTOOL>`_
